const drawer=document.getElementById('drawer');document.getElementById('menuBtn').onclick=()=>drawer.classList.remove('closed');document.getElementById('closeDrawer').onclick=()=>drawer.classList.add('closed');document.querySelectorAll('.nav-link').forEach(a=>a.addEventListener('click',()=>{if(innerWidth<900)drawer.classList.add('closed')}));const fmtDate=v=>{if(!v)return'—';const d=new Date(v);return isNaN(d)?v:d.toLocaleDateString('ar-SA')};async function loadManifest(){const resp=await fetch('assets/manifest.json');const data=await resp.json();const imgSel=(id,list)=>{const s=document.getElementById(id);s.innerHTML='';list.forEach(src=>{const o=document.createElement('option');o.value=src;o.textContent=src.split('/').pop();s.appendChild(o)})};imgSel('ct_logo_select',data.images);imgSel('ct_stamp_select',['','assets/images/stamp.png']);imgSel('cg_bg_select',['','assets/images/bg1.png','assets/images/bg2.png']);imgSel('rw_logo_select',['assets/images/header.png','assets/images/logo.png']);const ulImgs=document.getElementById('imagesList');data.images.forEach(p=>{const li=document.createElement('li');li.innerHTML=`<a href="${p}" target="_blank">${p.split('/').pop()}</a>`;ulImgs.appendChild(li)});const ulDocs=document.getElementById('docsList');data.docs.forEach(p=>{const li=document.createElement('li');li.innerHTML=`<a href="${p}" target="_blank">${p.split('/').pop()}</a>`;ulDocs.appendChild(li)})}loadManifest();document.getElementById('ct_logo_upload').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const url=URL.createObjectURL(f);document.getElementById('ct_logo_img').src=url});document.getElementById('cg_bg_upload').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const url=URL.createObjectURL(f);document.getElementById('cg_bg_img').src=url});window.renderThanks=function(){document.getElementById('ct_out_name').textContent=document.getElementById('ct_name').value||'—';document.getElementById('ct_out_reason').textContent=document.getElementById('ct_reason').value||'جهودها المتميزة';document.getElementById('ct_out_date').textContent=fmtDate(document.getElementById('ct_date').value);document.getElementById('ct_out_teacher').textContent=document.getElementById('ct_teacher').value||'—';document.getElementById('ct_out_serial').textContent=(document.getElementById('ct_serial').value||'').trim()?('رقم: '+document.getElementById('ct_serial').value):'';const logo=document.getElementById('ct_logo_select').value;if(logo)document.getElementById('ct_logo_img').src=logo;const stamp=document.getElementById('ct_stamp_select').value;document.getElementById('ct_stamp_img').src=stamp||'';document.getElementById('ct_stamp_img').style.display=stamp?'block':'none'};window.renderGeneric=function(){document.getElementById('cg_out_name').textContent=document.getElementById('cg_name').value||'—';document.getElementById('cg_out_reason').textContent=document.getElementById('cg_reason').value||'تفوقها الدراسي';document.getElementById('cg_out_date').textContent=fmtDate(document.getElementById('cg_date').value);document.getElementById('cg_out_teacher').textContent=document.getElementById('cg_teacher').value||'—';const bg=document.getElementById('cg_bg_select').value;if(bg)document.getElementById('cg_bg_img').src=bg};window.renderWeekly=function(){document.getElementById('rw_out_teacher').textContent=document.getElementById('rw_teacher').value||'—';document.getElementById('rw_out_week').textContent=document.getElementById('rw_week').value||'—';document.getElementById('rw_out_date').textContent=fmtDate(document.getElementById('rw_date').value);document.getElementById('rw_out_done').textContent=document.getElementById('rw_done').value||'—';document.getElementById('rw_out_chal').textContent=document.getElementById('rw_chal').value||'—';document.getElementById('rw_out_reco').textContent=document.getElementById('rw_reco').value||'—';const logo=document.getElementById('rw_logo_select').value;document.getElementById('rw_logo_img').src=logo};window.downloadPDF=async function(id,filename){const el=document.getElementById(id);const canvas=await html2canvas(el,{scale:2});const img=canvas.toDataURL('image/png');const pdf=new jspdf.jsPDF('p','mm','a4');pdf.addImage(img,'PNG',0,0,pdf.internal.pageSize.getWidth(),pdf.internal.pageSize.getHeight());pdf.save(filename+'.pdf')};async function readCSV(file){const t=await file.text();const rows=t.split(/\r?\n/).filter(Boolean).map(r=>r.split(','));const header=rows.shift().map(h=>h.trim());return rows.map(c=>{const o={};header.forEach((h,i)=>o[h]=(c[i]||'').trim());return o})}window.batchGenerate=async function(type){const f=document.getElementById('csvFile').files[0];if(!f)return alert('اختاري ملف CSV');const recs=await readCSV(f);const log=document.getElementById('batchLog');log.textContent=`سيتم إنشاء ${recs.length} شهادة...\n`;const zip=new JSZip();const tmp=type==='thanks'?'preview-thanks':'preview-generic';for(const r of recs){if(type==='thanks'){ct_name.value=r.name||'';ct_reason.value=r.reason||'';ct_date.value=r.date||'';ct_teacher.value=r.teacher||'';ct_serial.value=r.serial||'';renderThanks()}else{cg_name.value=r.name||'';cg_reason.value=r.reason||'';cg_date.value=r.date||'';cg_teacher.value=r.teacher||'';renderGeneric()}const canvas=await html2canvas(document.getElementById(tmp),{scale:2});const b64=canvas.toDataURL('image/png').split(',')[1];const fname=(type==='thanks'?'شكر-':'تفوق-')+(r.name||'بدون-اسم')+'.png';zip.file(fname,b64,{base64:true});log.textContent+='✔︎ '+fname+'\n'}const blob=await zip.generateAsync({type:'blob'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='شهادات.zip';a.click()};